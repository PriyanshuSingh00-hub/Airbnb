<% layout('layout/boilerplate') %>
<div class="row mt-3">
    <div class="col-8 offset-2" >

        <br><br>


    <h3>Add Your New Listing.</h3>
    <form method="POST" action="/listings" novalidate class="needs-validation" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
         <input 
         name = "listing[title]" 
         placeholder="enter title" 
         type="text"  
         class="form-control"
         required />
         <div class="valid-feedback">Awesome Place.</div>
         <div class="invalid-feedback">Must enter the name of the place</div>
      </div>
      

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea name = "listing[description]"
              type="text"
              class="form-control"
              required></textarea> 
              <div class="invalid-feedback">Write something for description !</div>
        </div>

         <!-- <div class="mb-3">
            <label for="image" class="form-label">Image Link</label>
             <input name = "listing[image][url]" type="text"  class="form-control"
             required/>
             <div class="invalid-feedback">You should upload a img</div>
         </div> -->

         <div class="mb-3">
            <label for="image" class="form-label">Upload  Listing Img</label>
             <input name = "image" placeholder="enter image url" type="file"  class="form-control"
             required/>
             <div class="invalid-feedback">You should upload a img</div>
         </div>

         <div class="row">
             
        <div class="mb-3 col-md-4">
  <label for="price" class="form-label">Price</label>
  <input 
    name="listing[price]" 
    placeholder="enter price" 
   
    class="form-control" 
    required
  />
  <div class="invalid-feedback">Price should be valid!</div>
</div>




          <div class="mb-3 col-md-8">
             <label for="country" class="form-label">Country</label>
             <input name = "listing[country]" placeholder="enter country" type="text" class="form-control" required />
             <div class="invalid-feedback">Enter your country</div>
         </div>
         </div>
        

          
         <div class="mb-3">
            <label for="location" class="form-label">Location</label>
            <div class="input-group">
              <input 
                id="locationInput"
                name="listing[location]" 
                placeholder="enter location (e.g., Times Square, Paris, Tokyo)" 
                type="text" 
                class="form-control" 
                required 
              />
              <button 
                class="btn btn-outline-secondary" 
                type="button" 
                id="searchLocationBtn"
              >
                Search
              </button>
            </div>
            <div class="invalid-feedback">Enter your location.</div>
            <small class="form-text text-muted">Click "Search" to find the location and update map</small>
         </div>

         <!-- Hidden coordinate fields (auto-filled by geocoding) -->
         <input type="hidden" id="latitudeInput" name="listing[geometry][coordinates][1]" value="28.6139" />
         <input type="hidden" id="longitudeInput" name="listing[geometry][coordinates][0]" value="77.2090" />

         <!-- Preview Map -->
         <div class="mb-3">
            <label class="form-label">Location Preview (Map)</label>
            <div id="previewMap" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
         </div>

         <button class="btn btn-dark add-btn mt-3" >ADD!</button>
         <br><br><br>

         <script src="/JS/geocoding.js"></script>
         <script>
           const mapToken = "<%=process.env.MAP_TOKEN%>";
           const locationInput = document.getElementById('locationInput');
           const searchBtn = document.getElementById('searchLocationBtn');

           // Search on button click
           searchBtn.addEventListener('click', async function(e) {
             e.preventDefault();
             console.log("Search button clicked");
             await updateMapLocation(locationInput, mapToken, 'previewMap');
           });

           // Auto-search when leaving the field (blur)
           locationInput.addEventListener('blur', async function() {
             if (this.value.trim()) {
               console.log("Auto-searching for location on blur");
               await updateMapLocation(this, mapToken, 'previewMap');
             }
           });

           // Search on Enter key
           locationInput.addEventListener('keypress', async function(e) {
             if (e.key === 'Enter') {
               e.preventDefault();
               console.log("Search triggered by Enter key");
               await updateMapLocation(this, mapToken, 'previewMap');
             }
           });
         </script>
         
    </form>
    </div>
</div>
</html>