<% layout('layout/boilerplate') %>

<div class="row mt-3">
    <div class="col-8 offset-2" >

  <h3>Edit your Listing:</h3>

  <form method="POST" 
  action="/listings/<%= listing._id %>?_method=PUT" 
  novalidate class="needs-validation"
  enctype="multipart/form-data">

    <div class="mb-3">
      <label for="title" class="form-label">Title</label>
      <input
        name="listing[title]"
        value="<%= listing.title %>"
        type="text"
        class="form-control"
        id="title"
        required
      />
      <div class="valid-feedback">Awesome Place</div>
         <div class="invalid-feedback">Must enter the name of the Place</div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Description</label>
      <textarea
        name="listing[description]"
        class="form-control"
        id="description"
         required
      ><%= listing.description %></textarea>
       <div class="invalid-feedback">write something for description.!</div>
    </div>

    <div class="mb-3">
      <img src="<%=originalImgUrl%>">
    </div>

    <div class="mb-3">
      <label for="image" class="form-label">Upload new Image</label>
      <input
        name="image"
        type="file"
        class="form-control"
        id="image"
       
      />
      
    </div>

<div class="row">
    <div class="mb-3 col-md-4">
      <label for="price" class="form-label">Price</label>
      <input
        name="listing[price]"
        value="<%= listing.price %>"
        
        class="form-control"
        id="price"
        required
      />
        <div class="invalid-feedback">Price should be valid!</div>
    </div>

    <div class="mb-3 col-md-8">
      <label for="country" class="form-label">Country</label>
      <input
        name="listing[country]"
        value="<%= listing.country %>"
        type="text"
        class="form-control"
        id="country"
        required
      />
          <div class="invalid-feedback">Enter your country</div>
    </div>
</div>

    <div class="mb-3">
      <label for="location" class="form-label">Location</label>
      <div class="input-group">
        <input
          id="locationInput"
          name="listing[location]"
          value="<%= listing.location %>"
          type="text"
          class="form-control"
          id="location"
          required
        />
        <button 
          class="btn btn-outline-secondary" 
          type="button" 
          id="searchLocationBtn"
        >
          Search Location
        </button>
      </div>
      <div class="invalid-feedback">Enter your location.</div>
    </div>

    <!-- Hidden coordinate fields (auto-filled by geocoding.) -->
    <input type="hidden" id="latitudeInput" name="listing[geometry][coordinates][1]" value="<%= listing.geometry.coordinates[1] %>" />
    <input type="hidden" id="longitudeInput" name="listing[geometry][coordinates][0]" value="<%= listing.geometry.coordinates[0] %>" />

    <!-- Preview Map. -->
    <div class="mb-3">
      <label class="form-label">Location Preview</label>
      <div id="previewMap" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
    </div>

    <button class="btn btn-dark edit-btn mt-3">EDIT</button>

    <script src="/JS/geocoding.js"></script>
    <script>
      const mapToken = "<%=process.env.MAP_TOKEN%>";
      const locationInput = document.getElementById('locationInput');
      const searchBtn = document.getElementById('searchLocationBtn');

      // Search on button click
      searchBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log("Search button clicked");
        await updateMapLocation(locationInput, mapToken, 'previewMap');
      });

      // Auto-search when leaving the field (blur)
      locationInput.addEventListener('blur', async function() {
        if (this.value.trim()) {
          console.log("Auto-searching for location on blur");
          await updateMapLocation(this, mapToken, 'previewMap');
        }
      });

      // Search on Enter key
      locationInput.addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          console.log("Enter key pressed");
          await updateMapLocation(this, mapToken, 'previewMap');
        }
      });

      // Initialize preview map with current location
      window.addEventListener('load', function() {
        const coordinates = [<%= listing.geometry.coordinates[0] %>, <%= listing.geometry.coordinates[1] %>];
        if (coordinates[0] !== 0 || coordinates[1] !== 0) {
          initializePreviewMap(coordinates, mapToken, 'previewMap');
        }
      });
    </script>
  </form>
</div>
</div>

    </div>
</div>
 <script src="/JS/script.js"></script>

</html>
